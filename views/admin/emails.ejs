<%- include('../partials/header') %>

<div class="admin-layout">
  <!-- Admin Sidebar -->
  <aside class="admin-sidebar">
    <div class="sidebar-header">
      <h2>Admin Panel</h2>
      <span class="admin-name"><%= user.name %></span>
    </div>
    <nav class="sidebar-nav">
      <a href="/admin" class="sidebar-link">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
          <circle cx="9" cy="7" r="4"></circle>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
        </svg>
        Attendees
      </a>
      <a href="/admin/surveys" class="sidebar-link">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
          <path d="M9 11l3 3L22 4"></path>
          <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
        </svg>
        Surveys
      </a>
      <a href="/admin/emails" class="sidebar-link active">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
          <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
          <polyline points="22,6 12,13 2,6"></polyline>
        </svg>
        Email Logs
      </a>
      <a href="/admin/email-scheduler" class="sidebar-link">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        Email Scheduler
      </a>
      <a href="/admin/analytics" class="sidebar-link">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
          <line x1="18" y1="20" x2="18" y2="10"></line>
          <line x1="12" y1="20" x2="12" y2="4"></line>
          <line x1="6" y1="20" x2="6" y2="14"></line>
        </svg>
        Analytics
      </a>
      <a href="/admin/settings" class="sidebar-link">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
          <circle cx="12" cy="12" r="3"></circle>
          <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
        </svg>
        Settings
      </a>
      <a href="/admin/export" class="sidebar-link">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        Export CSV
      </a>
      <a href="/" class="sidebar-link" target="_blank">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
          <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
          <polyline points="15 3 21 3 21 9"></polyline>
          <line x1="10" y1="14" x2="21" y2="3"></line>
        </svg>
        View Site
      </a>
      <a href="/auth/logout" class="sidebar-link">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
          <polyline points="16 17 21 12 16 7"></polyline>
          <line x1="21" y1="12" x2="9" y2="12"></line>
        </svg>
        Logout
      </a>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="admin-main">
    <div class="admin-header">
      <h1>Email Logs</h1>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
            <polyline points="22,6 12,13 2,6"></polyline>
          </svg>
        </div>
        <div class="stat-info">
          <span class="stat-value"><%= stats.total %></span>
          <span class="stat-label">Total Emails</span>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon stat-icon-green">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
        </div>
        <div class="stat-info">
          <span class="stat-value"><%= stats.sent %></span>
          <span class="stat-label">Sent</span>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon stat-icon-red">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="15" y1="9" x2="9" y2="15"></line>
            <line x1="9" y1="9" x2="15" y2="15"></line>
          </svg>
        </div>
        <div class="stat-info">
          <span class="stat-value"><%= stats.failed %></span>
          <span class="stat-label">Failed</span>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon stat-icon-yellow">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>
          </svg>
        </div>
        <div class="stat-info">
          <span class="stat-value"><%= stats.skipped %></span>
          <span class="stat-label">Skipped</span>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="filter-card">
      <form action="/admin/emails" method="GET" class="filter-form">
        <div class="filter-group">
          <label for="status">Status:</label>
          <select name="status" id="status" onchange="this.form.submit()">
            <option value="all" <%= statusFilter === 'all' ? 'selected' : '' %>>All</option>
            <option value="sent" <%= statusFilter === 'sent' ? 'selected' : '' %>>Sent</option>
            <option value="failed" <%= statusFilter === 'failed' ? 'selected' : '' %>>Failed</option>
            <option value="skipped" <%= statusFilter === 'skipped' ? 'selected' : '' %>>Skipped</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="type">Type:</label>
          <select name="type" id="type" onchange="this.form.submit()">
            <option value="all" <%= typeFilter === 'all' ? 'selected' : '' %>>All</option>
            <option value="confirmation" <%= typeFilter === 'confirmation' ? 'selected' : '' %>>Confirmation</option>
            <option value="reminder" <%= typeFilter === 'reminder' ? 'selected' : '' %>>Reminder</option>
            <option value="resend" <%= typeFilter === 'resend' ? 'selected' : '' %>>Resend</option>
          </select>
        </div>
      </form>
    </div>

    <!-- Email Logs Table -->
    <div class="table-card">
      <div class="table-header">
        <h2>Email History</h2>
        <span class="table-count"><%= totalCount %> total</span>
      </div>

      <% if (typeof migrationNeeded !== 'undefined' && migrationNeeded) { %>
        <div class="empty-state">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="48" height="48">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          <p><strong>Database Migration Required</strong></p>
          <p style="color: #64748b; margin-top: 10px;">Run this command on your server to create the EmailLog table:</p>
          <code style="background: #1e293b; color: #22c55e; padding: 10px 15px; border-radius: 6px; display: inline-block; margin-top: 10px;">npx prisma db push</code>
          <p style="color: #64748b; margin-top: 10px;">Then restart your app.</p>
        </div>
      <% } else if (emailLogs.length === 0) { %>
        <div class="empty-state">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="48" height="48">
            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
            <polyline points="22,6 12,13 2,6"></polyline>
          </svg>
          <p>No email logs found.</p>
        </div>
      <% } else { %>
        <div class="table-responsive">
          <table class="data-table">
            <thead>
              <tr>
                <th>Recipient</th>
                <th>Subject</th>
                <th>Type</th>
                <th>Status</th>
                <th>Error</th>
                <th>Timestamp</th>
              </tr>
            </thead>
            <tbody>
              <% emailLogs.forEach(log => { %>
                <tr>
                  <td>
                    <strong><%= log.toName || '-' %></strong><br>
                    <small class="email-cell"><%= log.toEmail %></small>
                  </td>
                  <td class="subject-cell"><%= log.subject %></td>
                  <td>
                    <span class="badge badge-<%= log.type === 'confirmation' ? 'primary' : log.type === 'reminder' ? 'info' : 'secondary' %>">
                      <%= log.type %>
                    </span>
                  </td>
                  <td>
                    <% if (log.status === 'sent') { %>
                      <span class="badge badge-success">Sent</span>
                    <% } else if (log.status === 'failed') { %>
                      <span class="badge badge-danger">Failed</span>
                    <% } else { %>
                      <span class="badge badge-warning">Skipped</span>
                    <% } %>
                  </td>
                  <td class="error-cell">
                    <% if (log.errorMessage) { %>
                      <span class="error-text" title="<%= log.errorMessage %>">
                        <%= log.errorMessage.substring(0, 50) %><%= log.errorMessage.length > 50 ? '...' : '' %>
                      </span>
                      <% if (log.errorCode) { %>
                        <br><small>Code: <%= log.errorCode %></small>
                      <% } %>
                    <% } else { %>
                      -
                    <% } %>
                  </td>
                  <td>
                    <%= new Date(log.timestamp).toLocaleString() %>
                  </td>
                </tr>
              <% }); %>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <% if (totalPages > 1) { %>
          <div class="pagination">
            <% if (page > 1) { %>
              <a href="/admin/emails?page=<%= page - 1 %>&status=<%= statusFilter %>&type=<%= typeFilter %>" class="pagination-btn">
                &laquo; Previous
              </a>
            <% } %>

            <span class="pagination-info">
              Page <%= page %> of <%= totalPages %>
            </span>

            <% if (page < totalPages) { %>
              <a href="/admin/emails?page=<%= page + 1 %>&status=<%= statusFilter %>&type=<%= typeFilter %>" class="pagination-btn">
                Next &raquo;
              </a>
            <% } %>
          </div>
        <% } %>
      <% } %>
    </div>
  </main>
</div>

<style>
  .filter-card {
    background: white;
    padding: 15px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  .filter-form {
    display: flex;
    gap: 20px;
    align-items: center;
    flex-wrap: wrap;
  }

  .filter-group {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .filter-group label {
    font-weight: 500;
    color: #64748b;
  }

  .filter-group select {
    padding: 8px 12px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    background: white;
    font-size: 14px;
    cursor: pointer;
  }

  .stat-icon-red {
    background: #fef2f2;
    color: #dc2626;
  }

  .stat-icon-yellow {
    background: #fef9c3;
    color: #ca8a04;
  }

  .badge-primary {
    background: #e0f2fe;
    color: #0369a1;
  }

  .badge-info {
    background: #e0f2fe;
    color: #0891b2;
  }

  .badge-secondary {
    background: #f1f5f9;
    color: #64748b;
  }

  .badge-danger {
    background: #fef2f2;
    color: #dc2626;
  }

  .subject-cell {
    max-width: 250px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .error-cell {
    max-width: 200px;
    font-size: 12px;
    color: #dc2626;
  }

  .error-text {
    cursor: help;
  }

  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    padding: 20px;
    border-top: 1px solid #e2e8f0;
  }

  .pagination-btn {
    padding: 8px 16px;
    background: #2563eb;
    color: white;
    text-decoration: none;
    border-radius: 6px;
    font-size: 14px;
  }

  .pagination-btn:hover {
    background: #1d4ed8;
  }

  .pagination-info {
    color: #64748b;
    font-size: 14px;
  }
</style>

<%- include('../partials/footer') %>
